# 마지막 행에서 오프셋 방안 동작 분석

## 현재 오프셋 방안의 로직

1. 커서를 목표 위치로 이동
2. 목표 위치 + 오프셋(예: 5줄) 아래로 커서 이동
3. 다시 목표 위치로 커서 복귀

**의도:** 2번에서 아래로 내려가면서 스크롤이 조정되고, 3번에서 커서만 원위치하면 스크롤은 유지되어 목표 위치가 화면 상단 쪽에 보임

---

## 문제 상황: 커서가 마지막 행에 있는 경우

### 예시
- 문서 총 줄 수: 100줄
- 목표 위치: 100번 줄 (마지막 줄)
- 오프셋 설정: 5줄

### 실제 동작 흐름

**1단계:** 100번 줄로 커서 이동
- 스크롤이 100번 줄을 보여줌
- 하지만 100번 줄이 화면 맨 아래에 위치

**2단계:** 100 + 5 = 105번 줄로 이동 시도
- 하지만 105번 줄은 존재하지 않음
- `Math.min(105, 100) = 100`으로 제한됨
- 결과: 다시 100번 줄로 이동 (이미 있는 위치)
- **스크롤 변화 없음**

**3단계:** 다시 100번 줄로 이동
- 이미 100번 줄에 있으므로 아무 일도 안 일어남
- **스크롤 변화 없음**

### 최종 결과
- 커서는 100번 줄에 있음 ✓
- 하지만 100번 줄이 화면 **맨 아래**에 붙어 있음 ✗
- **오프셋 효과가 전혀 적용되지 않음**

---

## 왜 실패하는가?

**핵심 문제:**
- 오프셋 방안은 "더 아래로 갔다가 돌아오기"에 의존
- 마지막 줄보다 아래는 존재하지 않음
- 갈 곳이 없으니 스크롤이 조정되지 않음

**비유:**
- 건물 5층에서 10층으로 올라갔다가 5층으로 내려오면 → 5층이 눈높이 중간에 보임
- 건물 10층(최상층)에서 15층으로 올라가려 해도 → 10층이 최대, 못 올라감, 여전히 10층이 최상층

---

## 해결 방안

### 방안 1: 문서 끝에 임시 빈 줄 추가
**로직:**
1. 커서를 목표 위치로 이동
2. 문서 맨 끝에 빈 줄을 오프셋만큼 추가 (예: 5줄)
3. 이제 문서가 105줄이 됨
4. 105번 줄로 커서 이동 (스크롤 조정됨)
5. 다시 목표 위치(100번)로 커서 복귀
6. 추가한 빈 줄 삭제

**장점:**
- 확실하게 작동
- 마지막 줄에서도 오프셋 효과 보장

**단점:**
- 복잡함
- 파일을 수정했다가 복구해야 함
- Undo 히스토리나 깜빡임 문제 가능성

---

### 방안 2: 조건부 처리 - 마지막 줄 근처인지 확인
**로직:**
1. 목표 위치가 문서 끝에서 오프셋 범위 내인지 확인
2. 그렇다면: 다른 방식 사용 (예: 문서 끝으로 스크롤)
3. 그렇지 않다면: 기존 오프셋 방식 사용

**예시:**
- 목표가 95번 줄이고 문서가 100줄이면 (끝에서 5줄 이내)
  - 그냥 문서 끝(100줄)으로 스크롤
  - 그러면 95번 줄이 화면 상단 쪽에 보임
- 목표가 50번 줄이고 문서가 100줄이면
  - 55번 줄로 갔다가 50번 줄로 돌아오기

**장점:**
- 비교적 간단
- 마지막 줄 근처와 중간을 다르게 처리

**단점:**
- 경계 케이스 처리 필요
- 두 가지 로직 유지

---

### 방안 3: 역방향 접근 - 위로 올라갔다가 내려오기
**로직:**
1. 목표 위치보다 오프셋만큼 **위**로 커서 이동
2. 다시 목표 위치로 커서 이동

**예시 (마지막 줄):**
- 목표: 100번 줄
- 먼저 95번 줄로 이동 (스크롤이 95번을 보여줌)
- 다시 100번 줄로 이동 (스크롤이 조정되어 100번이 화면 하단 쪽에 보임)

**장점:**
- 마지막 줄에서도 작동
- 간단함

**단점:**
- 첫 줄 근처에서는 문제 발생 (위로 갈 수 없음)
- 스크롤 방향이 직관적이지 않음
- **원하는 효과와 반대:** 목표가 화면 **하단**에 위치하게 됨

---

### 방안 4: 항상 문서 끝으로 스크롤 (단순화)
**로직:**
1. 커서를 목표 위치로 이동
2. 추가로 문서 맨 끝으로 스크롤 시도

**예시:**
- 목표: 100번 줄 (마지막)
- 100번 줄로 커서 이동
- 문서 끝으로 스크롤 (이미 100번이 끝이므로 최대한 스크롤)

**장점:**
- 매우 간단

**단점:**
- 목표가 문서 중간에 있으면 커서가 화면 밖으로 사라짐
- 일관성 없는 동작

---

### 방안 5: 스크롤을 직접 제어하는 API 사용
**로직:**
- CodeMirror나 Obsidian에서 제공하는 스크롤 API로 "이 줄을 화면 중앙에" 같은 명령 실행

**장점:**
- 가장 깔끔하고 정확함
- 모든 경우에 일관되게 작동

**단점:**
- 해당 API가 있는지 확인 필요
- Obsidian에서 노출되지 않았을 수 있음

---

### 방안 6: 하이브리드 - 문서 끝 체크 후 분기
**로직:**
1. 목표 위치 + 오프셋이 문서 끝을 넘는지 확인
2. 넘지 않으면: 기존 오프셋 방식 (아래 갔다가 돌아오기)
3. 넘으면: 임시 빈 줄 추가 방식 또는 다른 보정

**장점:**
- 대부분의 경우 간단한 방식 사용
- 문제 상황에서만 특별 처리

**단점:**
- 코드 복잡도 증가

---

## 현실적인 추천

### 추천 1: 방안 1 (임시 빈 줄 추가) - 완벽하지만 복잡
가장 확실하지만 구현이 복잡함

### 추천 2: 방안 2 (조건부 처리) - 실용적
- 목표 + 오프셋 > 문서 끝인 경우:
  - 문서 끝으로 스크롤
- 그렇지 않은 경우:
  - 기존 오프셋 방식

### 추천 3: 현재 방식 유지 + 사용자에게 안내
- 대부분의 경우 잘 작동함
- 마지막 줄에서만 약간 아쉽지만, 치명적이지는 않음
- 설정에 "마지막 줄에서는 효과가 제한될 수 있음" 안내

---

## 가장 간단한 개선안

**로직:**
1. 목표 위치로 커서 이동
2. 오프셋 라인 계산
3. **만약 오프셋 라인이 문서 끝과 같다면:**
   - 임시로 빈 줄 1개 추가
   - 오프셋 라인으로 이동
   - 목표 위치로 복귀
   - 빈 줄 삭제
4. **그렇지 않다면:**
   - 기존 방식대로 (오프셋 라인 → 목표 위치)

**효과:**
- 마지막 줄 근처에서도 오프셋 효과 작동
- 나머지는 기존과 동일
